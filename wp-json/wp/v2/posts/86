{"id":86,"date":"2007-12-19T16:15:00","date_gmt":"2007-12-19T16:15:00","guid":{"rendered":"\/2007\/12\/19\/rails-date-select-bug-with-discard-and-disable"},"modified":"2007-12-19T16:15:00","modified_gmt":"2007-12-19T16:15:00","slug":"rails-date-select-bug-with-discard-and-disable","status":"publish","type":"post","link":"http:\/\/pullmonkey.com\/2007\/12\/19\/rails-date-select-bug-with-discard-and-disable\/","title":{"rendered":"Rails date select bug with discard and disable"},"content":{"rendered":"<h2>Code that breaks<\/h2>\n<table class=\"CodeRay\">\n<tr>\n<td class=\"line_numbers\" title=\"click to toggle\" onclick=\"with (this.firstChild.style) { display = (display == '') ? 'none' : '' }\">\n<pre>1<tt>\n<\/tt>2<tt>\n<\/tt>3<tt>\n<\/tt>4<tt>\n<\/tt><strong>5<\/strong><tt>\n<\/tt>6<tt>\n<\/tt>7<tt>\n<\/tt>8<tt>\n<\/tt><\/pre>\n<\/td>\n<td class=\"code\">\n<pre ondblclick=\"with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }\"><tt>\n<\/tt>&lt;%= date_select <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object<\/span><span class=\"dl\">&quot;<\/span><\/span>, <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">attr<\/span><span class=\"dl\">&quot;<\/span><\/span>, <tt>\n<\/tt>                 <span class=\"sy\">:index<\/span>       =&gt; <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"dl\">&quot;<\/span><\/span>, <tt>\n<\/tt>                 <span class=\"sy\">:start_year<\/span>  =&gt; <span class=\"co\">Date<\/span>.today.year, <tt>\n<\/tt>                 <span class=\"sy\">:discard_day<\/span> =&gt; <span class=\"pc\">true<\/span>, <tt>\n<\/tt>                 <span class=\"sy\">:disabled<\/span>    =&gt; <span class=\"pc\">true<\/span>, <tt>\n<\/tt>                 <span class=\"sy\">:order<\/span>       =&gt; [<span class=\"sy\">:month<\/span>, <span class=\"sy\">:year<\/span>] <span class=\"s\"><span class=\"dl\">%&gt;<\/span><span class=\"k\"><tt>\n<\/tt><tt>\n<\/tt><\/span><\/span><\/pre>\n<\/td>\n<\/tr>\n<\/table>\n<p><\/p>\n<h2>HTML that is produced<\/h2>\n<table class=\"CodeRay\">\n<tr>\n<td class=\"line_numbers\" title=\"click to toggle\" onclick=\"with (this.firstChild.style) { display = (display == '') ? 'none' : '' }\">\n<pre>1<tt>\n<\/tt>2<tt>\n<\/tt>3<tt>\n<\/tt>4<tt>\n<\/tt><strong>5<\/strong><tt>\n<\/tt>6<tt>\n<\/tt>7<tt>\n<\/tt>8<tt>\n<\/tt>9<tt>\n<\/tt><strong>10<\/strong><tt>\n<\/tt>11<tt>\n<\/tt>12<tt>\n<\/tt>13<tt>\n<\/tt>14<tt>\n<\/tt><strong>15<\/strong><tt>\n<\/tt>16<tt>\n<\/tt><\/pre>\n<\/td>\n<td class=\"code\">\n<pre ondblclick=\"with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }\"><tt>\n<\/tt><span class=\"ta\">&lt;input<\/span> <span class=\"an\">id<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object__attr_3i<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>       <span class=\"an\">type<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">hidden<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>       <span class=\"an\">value<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">1<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>       <span class=\"an\">name<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object[object_attributes][][attr(3i)]<\/span><span class=\"dl\">&quot;<\/span><\/span><span class=\"ta\">\/&gt;<\/span><tt>\n<\/tt><span class=\"ta\">&lt;select<\/span> <span class=\"an\">id<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object_attr_attributes__attr_2i<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>        <span class=\"an\">disabled<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">disabled<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>        <span class=\"an\">name<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object[object_attributes][][attr(2i)]<\/span><span class=\"dl\">&quot;<\/span><\/span><span class=\"ta\">&gt;<\/span><tt>\n<\/tt>...<tt>\n<\/tt><span class=\"ta\">&lt;\/select&gt;<\/span><tt>\n<\/tt><span class=\"ta\">&lt;select<\/span> <span class=\"an\">id<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object_attributes__attr_1i<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>        <span class=\"an\">disabled<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">disabled<\/span><span class=\"dl\">&quot;<\/span><\/span> <tt>\n<\/tt>        <span class=\"an\">name<\/span>=<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">object[object_attributes][][attr(1i)]<\/span><span class=\"dl\">&quot;<\/span><\/span><span class=\"ta\">&gt;<\/span><tt>\n<\/tt>...<tt>\n<\/tt><span class=\"ta\">&lt;\/select&gt;<\/span><tt>\n<\/tt><tt>\n<\/tt><\/pre>\n<\/td>\n<\/tr>\n<\/table>\n<p><\/p>\n<h2>The Problem<\/h2>\n<p>Note that this may be fixed now in version 2.0 of rails.  So the problem arises when you use both the options of disabled and discard for the date_select helper.  By themselves they work fine and without problems.  When you use them together the discard option overrides the disabled option.  In the example above, I discard the day and want the entire element to be disabled.  The resulting HTML hides the day selector but does not disable it.  So, when the form is submitted the date select day is bundled in with the rest of the parameters as a hash of just the day.  If it had been hidden and disabled, then we could have ignored it.<br \/>\n<\/p>\n<h2>The offending Rails Helper code<\/h2>\n<p><tt>hidden_html(...)<\/tt> is used anytime discard_&lt;something&gt; is set to true.<\/p>\n<table class=\"CodeRay\">\n<tr>\n<td class=\"line_numbers\" title=\"click to toggle\" onclick=\"with (this.firstChild.style) { display = (display == '') ? 'none' : '' }\">\n<pre>1<tt>\n<\/tt>2<tt>\n<\/tt>3<tt>\n<\/tt>4<tt>\n<\/tt><strong>5<\/strong><tt>\n<\/tt>6<tt>\n<\/tt>7<tt>\n<\/tt>8<tt>\n<\/tt>9<tt>\n<\/tt><strong>10<\/strong><tt>\n<\/tt>11<tt>\n<\/tt>12<tt>\n<\/tt>13<tt>\n<\/tt>14<tt>\n<\/tt><strong>15<\/strong><tt>\n<\/tt><\/pre>\n<\/td>\n<td class=\"code\">\n<pre ondblclick=\"with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }\"><tt>\n<\/tt><span class=\"r\">module<\/span> <span class=\"cl\">ActionView<\/span><tt>\n<\/tt>  <span class=\"r\">module<\/span> <span class=\"cl\">Helpers<\/span><tt>\n<\/tt>    ...<tt>\n<\/tt>    <span class=\"r\">module<\/span> <span class=\"cl\">DateHelper<\/span><tt>\n<\/tt>      ...<tt>\n<\/tt>      <span class=\"r\">def<\/span> <span class=\"fu\">hidden_html<\/span>(type, value, options)<tt>\n<\/tt>        name_and_id_from_options(options, type)<tt>\n<\/tt>        hidden_html = <span class=\"s\"><span class=\"dl\">%(<\/span><span class=\"k\">&lt;input type=&quot;hidden&quot; id=&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>options[<span class=\"sy\">:id<\/span>]<span class=\"dl\">}<\/span><\/span><span class=\"k\">&quot; name=&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>options[<span class=\"sy\">:name<\/span>]<span class=\"dl\">}<\/span><\/span><span class=\"k\">&quot; value=&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>value<span class=\"dl\">}<\/span><\/span><span class=\"k\">&quot; \/&gt;<\/span><span class=\"ch\">\\n<\/span><span class=\"dl\">)<\/span><\/span><tt>\n<\/tt>      <span class=\"r\">end<\/span><tt>\n<\/tt>      ...<tt>\n<\/tt>    <span class=\"r\">end<\/span><tt>\n<\/tt>  <span class=\"r\">end<\/span><tt>\n<\/tt><span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt><\/pre>\n<\/td>\n<\/tr>\n<\/table>\n<p><\/p>\n<h2>The fix<\/h2>\n<p>Note that in the above code there is no reference to the disabled parameter that was set.  Using a mixin, you can create a file in RAILS_ROOT\/lib named date_select_fix.rb with the following code:<\/p>\n<table class=\"CodeRay\">\n<tr>\n<td class=\"line_numbers\" title=\"click to toggle\" onclick=\"with (this.firstChild.style) { display = (display == '') ? 'none' : '' }\">\n<pre>1<tt>\n<\/tt>2<tt>\n<\/tt>3<tt>\n<\/tt>4<tt>\n<\/tt><strong>5<\/strong><tt>\n<\/tt>6<tt>\n<\/tt>7<tt>\n<\/tt>8<tt>\n<\/tt>9<tt>\n<\/tt><strong>10<\/strong><tt>\n<\/tt>11<tt>\n<\/tt>12<tt>\n<\/tt>13<tt>\n<\/tt>14<tt>\n<\/tt><strong>15<\/strong><tt>\n<\/tt><\/pre>\n<\/td>\n<td class=\"code\">\n<pre ondblclick=\"with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }\"><tt>\n<\/tt><span class=\"r\">module<\/span> <span class=\"cl\">ActionView<\/span><tt>\n<\/tt>  <span class=\"r\">module<\/span> <span class=\"cl\">Helpers<\/span><tt>\n<\/tt>    ...<tt>\n<\/tt>    <span class=\"r\">module<\/span> <span class=\"cl\">DateHelper<\/span><tt>\n<\/tt>      ...<tt>\n<\/tt>      <span class=\"r\">def<\/span> <span class=\"fu\">hidden_html<\/span>(type, value, options)<tt>\n<\/tt>        name_and_id_from_options(options, type)<tt>\n<\/tt>        hidden_html = <span class=\"s\"><span class=\"dl\">%(<\/span><span class=\"k\">&lt;input type=&quot;hidden&quot; id=&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>options[<span class=\"sy\">:id<\/span>]<span class=\"dl\">}<\/span><\/span><span class=\"k\">&quot; name=&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>options[<span class=\"sy\">:name<\/span>]<span class=\"dl\">}<\/span><\/span><span class=\"k\">&quot; value=&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>value<span class=\"dl\">}<\/span><\/span><span class=\"k\">&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span><span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\"> disabled=<\/span><span class=\"ch\">\\&quot;<\/span><span class=\"k\">disabled<\/span><span class=\"ch\">\\&quot;<\/span><span class=\"dl\">&quot;<\/span><\/span> <span class=\"r\">if<\/span> options[<span class=\"sy\">:disabled<\/span>]<span class=\"dl\">}<\/span><\/span><span class=\"k\"> \/&gt;<\/span><span class=\"ch\">\\n<\/span><span class=\"dl\">)<\/span><\/span><tt>\n<\/tt>      <span class=\"r\">end<\/span><tt>\n<\/tt>      ...<tt>\n<\/tt>    <span class=\"r\">end<\/span><tt>\n<\/tt>  <span class=\"r\">end<\/span><tt>\n<\/tt><span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt><\/pre>\n<\/td>\n<\/tr>\n<\/table>\n<p>\nWorks for me.  Just for the record, the project that I found this bug in is still using rails 1.2.1 and actionpack 1.13.1.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Code that breaks 1 2 3 4 5 6 7 8 &lt;%= date_select &quot;object&quot;, &quot;attr&quot;, :index =&gt; &quot;&quot;, :start_year =&gt; Date.today.year, :discard_day =&gt; true, :disabled =&gt; true, :order =&gt; [:month, :year] %&gt; HTML that is produced 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 &lt;input id=&quot;object__attr_3i&quot; type=&quot;hidden&quot; [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[6,3,5,9],"tags":[],"_links":{"self":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/86"}],"collection":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/comments?post=86"}],"version-history":[{"count":0,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/86\/revisions"}],"wp:attachment":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/media?parent=86"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/categories?post=86"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/tags?post=86"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}