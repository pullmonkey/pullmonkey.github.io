{"id":57,"date":"2007-10-11T15:54:00","date_gmt":"2007-10-11T15:54:00","guid":{"rendered":"\/2007\/12\/19\/cached-assets"},"modified":"2007-10-11T15:54:00","modified_gmt":"2007-10-11T15:54:00","slug":"cached-assets","status":"publish","type":"post","link":"http:\/\/pullmonkey.com\/2007\/10\/11\/cached-assets\/","title":{"rendered":"Cached Assets"},"content":{"rendered":"<p>I love the <a href=\"http:\/\/agilewebdevelopment.com\/plugins\/cachedassets\">CachedAssets<\/a> plugin for rails.  This plugin bundles all your css files into one and all your js files into one which helps <a href=\"http:\/\/developer.yahoo.com\/yslow\/\">make fewer http requests<\/a>, ultimately making your site respond faster.  <br \/>\nThe cached assets plugin does a great job of combining the assets, but the one flaw is that the resulting file is simply the MD5 Sum of the file names of the assets to be joined together. No matter the contents or the time-stamp of the asset files, the resulting name never changes.  Browsers tend to cache these files, which is good, but not when you made some recent changes.  I made a few adjustments to the cached assets plugin to name the resulting file based on the MD5 Sum of the asset files' last modified times.  Now the name is guaranteed to be different if something has changed.<br \/>\nHere is a diff of what the plugin gives us and what changes I have made:<br \/>\n<\/p>\n<table class=\"CodeRay\">\n<tr>\n<td class=\"line_numbers\" title=\"click to toggle\" onclick=\"with (this.firstChild.style) { display = (display == '') ? 'none' : '' }\">\n<pre>1<tt>\n<\/tt>2<tt>\n<\/tt>3<tt>\n<\/tt>4<tt>\n<\/tt><strong>5<\/strong><tt>\n<\/tt>6<tt>\n<\/tt>7<tt>\n<\/tt>8<tt>\n<\/tt>9<tt>\n<\/tt><strong>10<\/strong><tt>\n<\/tt>11<tt>\n<\/tt>12<tt>\n<\/tt>13<tt>\n<\/tt>14<tt>\n<\/tt><strong>15<\/strong><tt>\n<\/tt>16<tt>\n<\/tt>17<tt>\n<\/tt>18<tt>\n<\/tt>19<tt>\n<\/tt><strong>20<\/strong><tt>\n<\/tt>21<tt>\n<\/tt>22<tt>\n<\/tt>23<tt>\n<\/tt>24<tt>\n<\/tt><strong>25<\/strong><tt>\n<\/tt>26<tt>\n<\/tt>27<tt>\n<\/tt>28<tt>\n<\/tt>29<tt>\n<\/tt><strong>30<\/strong><tt>\n<\/tt>31<tt>\n<\/tt>32<tt>\n<\/tt>33<tt>\n<\/tt>34<tt>\n<\/tt><strong>35<\/strong><tt>\n<\/tt>36<tt>\n<\/tt>37<tt>\n<\/tt>38<tt>\n<\/tt>39<tt>\n<\/tt><strong>40<\/strong><tt>\n<\/tt>41<tt>\n<\/tt>42<tt>\n<\/tt>43<tt>\n<\/tt>44<tt>\n<\/tt><strong>45<\/strong><tt>\n<\/tt>46<tt>\n<\/tt>47<tt>\n<\/tt>48<tt>\n<\/tt>49<tt>\n<\/tt><strong>50<\/strong><tt>\n<\/tt>51<tt>\n<\/tt>52<tt>\n<\/tt>53<tt>\n<\/tt>54<tt>\n<\/tt><strong>55<\/strong><tt>\n<\/tt>56<tt>\n<\/tt><\/pre>\n<\/td>\n<td class=\"code\">\n<pre ondblclick=\"with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }\"><tt>\n<\/tt>[pullmonkey]<span class=\"er\">$<\/span> diff -ru cached_assets\/lib\/cached_assets.rb cached_assets_pullmonkey\/lib\/cached_assets.rb<tt>\n<\/tt>--- cached_assets\/lib\/cached_assets.rb  <span class=\"i\">2007<\/span><span class=\"i\">-04<\/span><span class=\"i\">-08<\/span> <span class=\"i\">11<\/span>:<span class=\"i\">52<\/span>:<span class=\"fl\">36.000000000<\/span> <span class=\"i\">-0700<\/span><tt>\n<\/tt>+++ cached_assets_pullmonkey\/lib\/cached_assets.rb       <span class=\"i\">2007<\/span><span class=\"i\">-10<\/span><span class=\"i\">-09<\/span> <span class=\"i\">11<\/span>:<span class=\"i\">30<\/span>:<span class=\"fl\">48.000000000<\/span> <span class=\"i\">-0700<\/span><tt>\n<\/tt><span class=\"er\">@<\/span><span class=\"er\">@<\/span> <span class=\"i\">-21<\/span>,<span class=\"i\">13<\/span> <span class=\"i\">+21<\/span>,<span class=\"i\">13<\/span> <span class=\"er\">@<\/span><span class=\"er\">@<\/span><tt>\n<\/tt><tt>\n<\/tt>       private<tt>\n<\/tt>         <span class=\"r\">def<\/span> <span class=\"fu\">cached_asset<\/span>(sources, type)<tt>\n<\/tt>-          cached_name = <span class=\"co\">Digest<\/span>::<span class=\"co\">MD5<\/span>.hexdigest(sources.join(<span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">,<\/span><span class=\"dl\">'<\/span><\/span>)) + (type == <span class=\"sy\">:js<\/span> ? <span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">.js<\/span><span class=\"dl\">'<\/span><\/span> : <span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">.css<\/span><span class=\"dl\">'<\/span><\/span>)<tt>\n<\/tt>-          cached_source = compute_public_cached_path(cached_name)<tt>\n<\/tt>-          cached_path = compute_store_path(cached_name)<tt>\n<\/tt>-<tt>\n<\/tt>           sources = js_defaults(sources) <span class=\"r\">if<\/span> type == <span class=\"sy\">:js<\/span> &amp;&amp; sources.include?(<span class=\"sy\">:defaults<\/span>)<tt>\n<\/tt><tt>\n<\/tt>-          assets = sources.map {|s| (type == <span class=\"sy\">:js<\/span> ? javascript_path(s) : stylesheet_path(s)).split(<span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">?<\/span><span class=\"dl\">'<\/span><\/span>) }<tt>\n<\/tt>+          assets = sources.map {|s| (type == <span class=\"sy\">:js<\/span> ? javascript_path2(s) : stylesheet_path2(s)).split(<span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">?<\/span><span class=\"dl\">'<\/span><\/span>) }<tt>\n<\/tt>+<tt>\n<\/tt>+          cached_name = <span class=\"co\">Digest<\/span>::<span class=\"co\">MD5<\/span>.hexdigest(assets.map{|a| <span class=\"co\">File<\/span>.stat(<span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span><span class=\"co\">ASSET_CACHE_STORE<\/span><span class=\"dl\">}<\/span><\/span><span class=\"k\">\/<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>a<span class=\"dl\">}<\/span><\/span><span class=\"dl\">&quot;<\/span><\/span>).mtime}.join(<span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">,<\/span><span class=\"dl\">'<\/span><\/span>)) + (type == <span class=\"sy\">:js<\/span> ? <span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">.js<\/span><span class=\"dl\">'<\/span><\/span> : <span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">.css<\/span><span class=\"dl\">'<\/span><\/span>)<tt>\n<\/tt>+          cached_source = compute_public_cached_path(cached_name)<tt>\n<\/tt>+          cached_path = compute_store_path(cached_name)<tt>\n<\/tt><tt>\n<\/tt>           <span class=\"r\">if<\/span> !<span class=\"co\">FileTest<\/span>.exist?(cached_path) || rails_asset_id(cached_source).to_i &lt; assets.map {|a| a.last.to_i }.max<tt>\n<\/tt>             <span class=\"co\">FileUtils<\/span>.makedirs(<span class=\"co\">File<\/span>.dirname(cached_path))<tt>\n<\/tt><span class=\"er\">@<\/span><span class=\"er\">@<\/span> <span class=\"i\">-38<\/span>,<span class=\"i\">6<\/span> <span class=\"i\">+38<\/span>,<span class=\"i\">7<\/span> <span class=\"er\">@<\/span><span class=\"er\">@<\/span><tt>\n<\/tt>             }<tt>\n<\/tt>           <span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt>+<tt>\n<\/tt>           cached_source<tt>\n<\/tt>         <span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt><span class=\"er\">@<\/span><span class=\"er\">@<\/span> <span class=\"i\">-53<\/span>,<span class=\"i\">7<\/span> <span class=\"i\">+54<\/span>,<span class=\"i\">7<\/span> <span class=\"er\">@<\/span><span class=\"er\">@<\/span><tt>\n<\/tt>         <span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt>         <span class=\"r\">def<\/span> <span class=\"fu\">asset_path<\/span>(src, type)<tt>\n<\/tt>-          <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span><span class=\"co\">RAILS_ROOT<\/span><span class=\"dl\">}<\/span><\/span><span class=\"k\">\/public<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>(type == <span class=\"sy\">:js<\/span> ? javascript_path(src) : stylesheet_path(src)).split(<span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">?<\/span><span class=\"dl\">'<\/span><\/span>).first<span class=\"dl\">}<\/span><\/span><span class=\"dl\">&quot;<\/span><\/span><tt>\n<\/tt>+          <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span><span class=\"co\">RAILS_ROOT<\/span><span class=\"dl\">}<\/span><\/span><span class=\"k\">\/public<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>(type == <span class=\"sy\">:js<\/span> ? javascript_path2(src) : stylesheet_path2(src)).split(<span class=\"s\"><span class=\"dl\">'<\/span><span class=\"k\">?<\/span><span class=\"dl\">'<\/span><\/span>).first<span class=\"dl\">}<\/span><\/span><span class=\"dl\">&quot;<\/span><\/span><tt>\n<\/tt>         <span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt>         <span class=\"r\">def<\/span> <span class=\"fu\">compute_public_cached_path<\/span>(src)<tt>\n<\/tt><span class=\"er\">@<\/span><span class=\"er\">@<\/span> <span class=\"i\">-63<\/span>,<span class=\"i\">6<\/span> <span class=\"i\">+64<\/span>,<span class=\"i\">14<\/span> <span class=\"er\">@<\/span><span class=\"er\">@<\/span><tt>\n<\/tt>         <span class=\"r\">def<\/span> <span class=\"fu\">compute_store_path<\/span>(src)<tt>\n<\/tt>           <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"il\"><span class=\"dl\">#{<\/span><span class=\"co\">ASSET_CACHE_STORE<\/span><span class=\"dl\">}<\/span><\/span><span class=\"il\"><span class=\"dl\">#{<\/span>compute_public_cached_path(src)<span class=\"dl\">}<\/span><\/span><span class=\"dl\">&quot;<\/span><\/span><tt>\n<\/tt>         <span class=\"r\">end<\/span><tt>\n<\/tt>+<tt>\n<\/tt>+        <span class=\"r\">def<\/span> <span class=\"fu\">javascript_path2<\/span>(src)<tt>\n<\/tt>+          <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">\/javascripts\/<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>src<span class=\"dl\">}<\/span><\/span><span class=\"k\">.js<\/span><span class=\"dl\">&quot;<\/span><\/span><tt>\n<\/tt>+        <span class=\"r\">end<\/span><tt>\n<\/tt>+<tt>\n<\/tt>+        <span class=\"r\">def<\/span> <span class=\"fu\">stylesheet_path2<\/span>(src)<tt>\n<\/tt>+          <span class=\"s\"><span class=\"dl\">&quot;<\/span><span class=\"k\">\/stylesheets\/<\/span><span class=\"il\"><span class=\"dl\">#{<\/span>src<span class=\"dl\">}<\/span><\/span><span class=\"k\">.css<\/span><span class=\"dl\">&quot;<\/span><\/span><tt>\n<\/tt>+        <span class=\"r\">end<\/span><tt>\n<\/tt>     <span class=\"r\">end<\/span><tt>\n<\/tt>   <span class=\"r\">end<\/span><tt>\n<\/tt> <span class=\"r\">end<\/span><tt>\n<\/tt><tt>\n<\/tt><\/pre>\n<\/td>\n<\/tr>\n<\/table>\n<p>\nI am not sure the plugin's intent, but I am sure it was designed to simply combine all the assets together, not to worry about browser caching.  I am pretty sure that this plugin in combination with <a href=\"http:\/\/agilewebdevelopment.com\/plugins\/show\/35\">Asset Timestamping plugin<\/a> would maybe do the trick, in the sense that the filename (resulting from the cached assets plugin) would never change and the asset timestamping plugin would append a timestamp to the end of the asset name, I.e. ?1147898838.  There is a problem with this though and it is discussed in great detail in the <a href=\"http:\/\/www.die.net\/musings\/page_load_time\/\">Optimizing Page Load Time Article<\/a>.<br \/>\nThis article states that in order for the browser to ALWAYS cache the file (which we really, really want until we change the name) then we need to stay away from the use of question mark timestamping.  So I believe I have presented the solution that best meets my requirements of having one css file, one js file and a way to avoid the stale browser cache when modifications have been made.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>I love the CachedAssets plugin for rails. This plugin bundles all your css files into one and all your js files into one which helps make fewer http requests, ultimately making your site respond faster. The cached assets plugin does a great job of combining the assets, but the one flaw is that the resulting [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[6,3,5,9],"tags":[],"_links":{"self":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/57"}],"collection":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/comments?post=57"}],"version-history":[{"count":0,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/57\/revisions"}],"wp:attachment":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/media?parent=57"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/categories?post=57"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/tags?post=57"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}