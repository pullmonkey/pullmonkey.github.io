{"id":57393,"date":"2009-09-14T21:02:13","date_gmt":"2009-09-14T21:02:13","guid":{"rendered":"http:\/\/pullmonkey.com\/?p=57393"},"modified":"2009-09-19T16:38:37","modified_gmt":"2009-09-19T16:38:37","slug":"thinning-it-out","status":"publish","type":"post","link":"http:\/\/pullmonkey.com\/2009\/09\/14\/thinning-it-out\/","title":{"rendered":"THINning it out"},"content":{"rendered":"<p>Been having problems with swap space and memory on my slicehost servers.\u00a0 And it is all apache's and mongrel's fault.\u00a0 That used to be the cool combination and now it is an ugly, sluggish beast.\u00a0 Just recently, I switched to nginx (to replace apache) and thin (to replace mongrel).\u00a0 So far so good, major speed improvements and definitely memory consumption improvements.<\/p>\n<p>I started out by switching everything over the nginx while keeping the mongrels alive, that was actually pretty easy.\u00a0 Information was available everywhere.<\/p>\n<p>Thinning everything via capistrano took a while, that wasn't as well documented.\u00a0 Thin was documented, capistrano was documented, but easy solutions as to how to combine the two were difficult to find.<\/p>\n<p>Here's the solution I was able to come up with -<\/p>\n<h2>Capistrano<\/h2>\n<p>My config for using mongrel used to look something like this -<\/p>\n<p>[code lang=\"ruby\"]<br \/>\nset :stages, %w(staging production)<br \/>\nset :default_stage, \"production\"<\/p>\n<p>require \"capistrano\/ext\/multistage\"<br \/>\nrequire \"mongrel_cluster\/recipes\"<\/p>\n<p>set :application, \"myapplication.com\"<br \/>\nset :user, \"appuser\"set :repository,\u00a0 \"http:\/\/svn.myapplication.com\/myapp\/trunk\"<br \/>\nset :deploy_to, \"\/var\/www\/#{application}\"<\/p>\n<p>role :app, application<br \/>\nrole :web, application<br \/>\nrole :db,\u00a0 application, :primary => true<\/p>\n<p>set :runner, user<br \/>\nset :keep_releases, 3<br \/>\nset(:mongrel_conf) { \"#{current_path}\/config\/mongrel_cluster.yml\" }<\/p>\n<p>deploy.task :after_update_code, :roles => [:web] do<br \/>\ndesc \"Copying the right mongrel cluster config for the current stage environment.\"<br \/>\nrun \"cp -f #{release_path}\/config\/mongrel_#{stage}.yml #{release_path}\/config\/mongrel_cluster.yml\"<br \/>\nend<\/p>\n<p>... <other things like symlinks><br \/>\n[\/code]<\/p>\n<p>Now that we are moving from mongrel to thin, no need for two lines in particular, one being the line that requires mongrel_cluster recipes and the other that sets the mongrel_cluster yaml config path.\u00a0 A third line changes from mongrel_cluster.yml to thin_cluster.yml.\u00a0 You get something like this:<\/p>\n<p>[code lang=\"ruby\"]<br \/>\nset :stages, %w(staging production)<br \/>\nset :default_stage, \"production\"<\/p>\n<p>require \"capistrano\/ext\/multistage\"<\/p>\n<p>set :application, \"myapplication.com\"<br \/>\nset :user, \"appuser\"<\/p>\n<p>set :repository,\u00a0 \"http:\/\/svn.myapplication.com\/myapp\/trunk\"<br \/>\nset :deploy_to, \"\/var\/www\/#{application}\"<\/p>\n<p>role :app, application<br \/>\nrole :web, application<br \/>\nrole :db,\u00a0 application, :primary => true<\/p>\n<p>set :runner, user<br \/>\nset :keep_releases, 3<\/p>\n<p>deploy.task :after_update_code, :roles => [:web] do<br \/>\ndesc \"Copying the right mongrel cluster config for the current stage environment.\"<br \/>\nrun \"cp -f #{release_path}\/config\/thin_#{stage}.yml #{release_path}\/config\/thin_cluster.yml\"<br \/>\nend<br \/>\n... <other things like symlinks><br \/>\n[\/code]<\/p>\n<p>Now we need to implement what mongrel recipes was doing for us, start, stop and restart but in terms of thin (added this to the bottom of my deploy.rb):<\/p>\n<p>[code lang=\"ruby\"]<br \/>\nnamespace :deploy do<br \/>\ndesc \"Restart the Thin processes on the app server.\"<br \/>\ntask :restart do<br \/>\nrun \"thin restart -C #{release_path}\/config\/thin_cluster.yml\"<br \/>\nend<br \/>\ndesc \"Start the Thin processes on the app server.\"<br \/>\ntask :start do<br \/>\nrun \"thin start -C #{release_path}\/config\/thin_cluster.yml\"<br \/>\nend<br \/>\ndesc \"Stop the Thin processes on the app server.\"<br \/>\ntask :stop do<br \/>\nrun \"thin stop -C #{release_path}\/config\/thin_cluster.yml\"<br \/>\nend<br \/>\nend<br \/>\n[\/code]<\/p>\n<p>Here's what my thin_cluster.yml looks like:<\/p>\n<p>[code lang=\"ruby\"]<\/p>\n<p>---<br \/>\nlog: log\/thin.log<br \/>\naddress: 127.0.0.1<br \/>\nport: 9000<br \/>\nchdir: \/var\/www\/myapp.com\/current<br \/>\nenvironment: production<br \/>\npid: tmp\/pids\/thin.pid<br \/>\nuser: www-user<br \/>\ngroup: www-data<br \/>\nservers: 3<br \/>\n[\/code]<\/p>\n<p>That's it and it has worked out nicely so far.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Been having problems with swap space and memory on my slicehost servers.\u00a0 And it is all apache&#8217;s and mongrel&#8217;s fault.\u00a0 That used to be the cool combination and now it is an ugly, sluggish beast.\u00a0 Just recently, I switched to nginx (to replace apache) and thin (to replace mongrel).\u00a0 So far so good, major speed [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[6,5,9,30],"tags":[69,70,210,211,43,68],"_links":{"self":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/57393"}],"collection":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/comments?post=57393"}],"version-history":[{"count":12,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/57393\/revisions"}],"predecessor-version":[{"id":57402,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/posts\/57393\/revisions\/57402"}],"wp:attachment":[{"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/media?parent=57393"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/categories?post=57393"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/pullmonkey.com\/wp-json\/wp\/v2\/tags?post=57393"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}